# Kubernetes Authentication

Authentication for Kubernetes can be a bit of complex subject. If you're reading this for the first time; you'll need to get familiar with [how authentication works in k8s](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#users-in-kubernetes) before proceeding.

In short; k8s doesn't have a concept of "traditional users and groups" (excluding `serviceAccounts` of course), and relies on "external" authenticaion to provide "users/groups".

Some of the common methods of authentication are `X509 Client Certs`, `Static Password File`, and `OpenID Connect Tokens`. Usually people go with OIDC since it's the most flexable. 

There are many tools that are OIDC compliant; and can "front end" authentication to "back end" systems. The most popular ones are [Dex](https://github.com/dexidp/dex#dex---a-federated-openid-connect-provider) and [Keycloak](https://github.com/keycloak/keycloak#keycloak). These OIDC can front end (and also federate) things like LDAP, Active Directory, Google Auth, and Github (to name a few)

In this howto we will set up Dex to broker the authentication for k8s and GitHub (you can easily modify it to use anything else). This assumes that you have installed kubernetes with [kops](k8s-kops.md#kubernetes-with-kops) and are using TLS with [let's encrypt](k8s-ingress-helm.md#tls). Most of the installs are done with [helm](../../README.md#helm) as well. I have "templates" for files I used [here](../examples)

I'll try and make it as generic as possible; but if you're reading this, I'm assuming you know your way around k8s already.


Labs:

* [Prerequisites](#prerequisites)
* [KubeAPIServer setup](#kubeapiserver-setup)
* [Configure Dex](#configure-dex)

## Prerequisites

Make sure you're in the `kube-system` namespace

```
kubectl config set-context --current --namespace=kube-system
```

First you have to create a new `Authorized oAuth App`  by going to your Organization's settings page. Fill it out with your server information. Here's an example...

![githuboauth](https://cdn-images-1.medium.com/max/800/1*4KAGf71GTJzEt_RExdPo4Q.png)

I used the above as an example and had these for my values

* Homepage URL: `https://dex.apps.k8s.example.com`
* Auth Callback: `https://dex.apps.k8s.example.com/callback`

Save the `Client ID` and `Client secret` generated by GitHub somewhere. You'll need these later

Create the SSL certificates for your `login` app and your `dex` app. If you're using letsencrypt; this should be easy. I have a template for this.

Download  the template

```
wget https://raw.githubusercontent.com/christianh814/kubernetes-toolbox/master/resources/examples/dex-certs-TEMPLATE.yaml
```

Set your env variables to use `envsubst`

```
export DEX_URL=dex.apps.k8s.example.com
export DEX_LOGIN_URL=login.apps.k8s.example.com
export LE_ISSUER=letsencrypt-prod
```

> I used `kubectl get clusterissuer` to get the name of the issuer to populate `LE_ISSUER`

Create your yaml

```
envsubst < dex-certs-TEMPLATE.yaml > dex-certs.yaml
```

Create these objects

```
kubectl create -f dex-certs.yaml
```

Verify that the certs get created (takes a miniute or so)

```
kubectl get certs
```

## KubeAPIServer setup

You will need to provide the OCID information to Kubernetes (specifically the API server) so that it knows how you plan on authenticating.

With `kops` this was easy. I first edited my config

```
kops edit cluster k8s.chx.osecloud.com
```

And I added the follwowing

```
  kubeAPIServer:
    anonymousAuth: false
    authorizationMode: RBAC
    oidcClientID: dex-k8s-authenticator
    oidcGroupsClaim: groups
    oidcIssuerURL: https://dex.apps.k8s.example.com/
    oidcUsernameClaim: email
```

Then I did a "rolling update"

```
kops update cluster --yes
kops rolling-update cluster --yes
```

**NOTE** If you're not using `kops` then you'll have to edit the kube-api's command line options when the service starts...here's an example

```
--authorization-mode=RBAC
--oidc-client-id=dex-k8s-authenticator
--oidc-groups-claim=groups
--oidc-issuer-url=https://dex.apps.k8s.example.com/
--oidc-username-claim=email
```
> If you used a self singed cert...you may need to pass something like this `--oidc-ca-file=/etc/ssl/certs/openid-ca.pem` as well.

## Configure Dex

For connecting Dex you'll need the Kubernetes certificate and key. Letâ€™s obtain from the master (default path for `kops` install is `/srv/kubernetes/`).

Sample output

```
cat /srv/kubernetes/ca.{crt,key}
-----BEGIN CERTIFICATE-----
AAAAAAAAAAABBBBBBBBBBCCCCCC
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
DDDDDDDDDDDEEEEEEEEEEFFFFFF
-----END RSA PRIVATE KEY-----
```

You are going to need the `dex-k8s-authenticator` repo; so clone that somewhere

```
git clone git@github.com:mintel/dex-k8s-authenticator.git
```

We will be using a helm chart to install both dex and the dex-authenticator. In order to do this you'll need to pass a "values yaml file". Create one for dex

```
```
